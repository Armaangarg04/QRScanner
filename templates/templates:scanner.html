<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR Code | QR Security Scanner</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-camera"></i> QR Code Scanner</h1>
            <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> Back to Home</a>
        </header>

        <div class="scanner-container">
            <div class="scanner-left">
                <h2><i class="fas fa-video"></i> Live Camera Scanner</h2>
                <div id="qr-reader" class="qr-reader"></div>
                <div class="scanner-controls">
                    <button id="start-scanner" class="btn-primary">
                        <i class="fas fa-play"></i> Start Camera
                    </button>
                    <button id="stop-scanner" class="btn-secondary" disabled>
                        <i class="fas fa-stop"></i> Stop Camera
                    </button>
                    <button id="upload-image" class="btn-secondary">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                </div>
                
                <div class="manual-input">
                    <h3><i class="fas fa-keyboard"></i> Manual Input</h3>
                    <textarea id="manual-input" placeholder="Or paste QR code content here..."></textarea>
                    <button onclick="checkManualInput()" class="btn-check">
                        <i class="fas fa-search"></i> Check Content
                    </button>
                </div>
            </div>
            
            <div class="scanner-right">
                <h2><i class="fas fa-search"></i> Analysis Results</h2>
                <div id="scan-results" class="results-container">
                    <div class="placeholder">
                        <i class="fas fa-qrcode"></i>
                        <p>Scan a QR code or upload an image to see analysis results</p>
                    </div>
                </div>
                
                <div class="history-section">
                    <h3><i class="fas fa-history"></i> Recent Scans</h3>
                    <div id="scan-history"></div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> How to Use</h3>
            <ol>
                <li>Allow camera access when prompted</li>
                <li>Point camera at QR code</li>
                <li>The scanner will automatically detect and analyze the QR code</li>
                <li>Review security analysis results</li>
                <li>For better results, ensure good lighting and focus</li>
            </ol>
        </div>
    </div>

    <script src="/static/script.js"></script>
    <script>
        // Scanner code (same as before but shorter for space)
        let html5QrCode;
        let scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');
        
        document.addEventListener('DOMContentLoaded', function() {
            html5QrCode = new Html5Qrcode("qr-reader");
            
            document.getElementById('start-scanner').addEventListener('click', startScanner);
            document.getElementById('stop-scanner').addEventListener('click', stopScanner);
            document.getElementById('upload-image').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', handleImageUpload);
            
            renderScanHistory();
        });
        
        async function startScanner() {
            const startBtn = document.getElementById('start-scanner');
            const stopBtn = document.getElementById('stop-scanner');
            
            try {
                const cameras = await Html5Qrcode.getCameras();
                if (cameras && cameras.length) {
                    const cameraId = cameras[0].id;
                    
                    await html5QrCode.start(
                        cameraId,
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        onScanSuccess,
                        onScanFailure
                    );
                    
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Scanning...';
                } else {
                    alert('No camera found');
                }
            } catch (err) {
                console.error("Camera start error:", err);
                alert('Failed to start camera: ' + err.message);
            }
        }
        
        function stopScanner() {
            html5QrCode.stop().then(() => {
                document.getElementById('start-scanner').disabled = false;
                document.getElementById('stop-scanner').disabled = true;
                document.getElementById('start-scanner').innerHTML = '<i class="fas fa-play"></i> Start Camera';
            }).catch(err => {
                console.error("Stop error:", err);
            });
        }
        
        async function onScanSuccess(decodedText) {
            if (scanHistory.length > 0 && scanHistory[0].text === decodedText) {
                return;
            }
            
            const scanItem = {
                text: decodedText,
                timestamp: new Date().toISOString(),
                isUrl: decodedText.startsWith('http://') || decodedText.startsWith('https://')
            };
            
            scanHistory.unshift(scanItem);
            if (scanHistory.length > 10) scanHistory = scanHistory.slice(0, 10);
            localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
            
            await processScannedContent(decodedText);
            renderScanHistory();
        }
        
        function onScanFailure(error) {
            console.warn("QR scan failure:", error);
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            html5QrCode.scanFile(file, true)
                .then(decodedText => {
                    onScanSuccess(decodedText);
                    event.target.value = '';
                })
                .catch(err => {
                    console.error("Image scan error:", err);
                    alert('Could not read QR code from image.');
                });
        }
        
        async function processScannedContent(text) {
            const resultsDiv = document.getElementById('scan-results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Analyzing content...
                </div>
            `;
            
            const isUrl = text.startsWith('http://') || text.startsWith('https://');
            
            if (isUrl) {
                try {
                    const response = await fetch('/api/check-url', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url: text })
                    });
                    
                    const data = await response.json();
                    
                    let statusClass = data.suspicious ? 'suspicious' : 'safe';
                    let statusIcon = data.suspicious ? 'fa-exclamation-triangle' : 'fa-check-circle';
                    let statusText = data.suspicious ? 'SUSPICIOUS' : 'SAFE';
                    
                    resultsDiv.innerHTML = `
                        <div class="result ${statusClass}">
                            <div class="result-header">
                                <i class="fas ${statusIcon}"></i>
                                <h3>QR Analysis Result: ${statusText}</h3>
                                <span class="scan-type">URL Detected</span>
                            </div>
                            <div class="content-box">
                                <p><strong>Scanned Content:</strong></p>
                                <div class="url-display">${text}</div>
                            </div>
                            <div class="details">
                                <p><strong>Domain:</strong> ${data.domain}</p>
                                <div class="scores">
                                    <div class="score-card">
                                        <span class="score-label">Domain Safety</span>
                                        <span class="score-value">${(100 - data.domain_prob * 100).toFixed(1)}%</span>
                                        <div class="score-bar">
                                            <div class="score-fill" style="width: ${100 - data.domain_prob * 100}%"></div>
                                        </div>
                                    </div>
                                    <div class="score-card">
                                        <span class="score-label">Content Safety</span>
                                        <span class="score-value">${data.content_prob ? (100 - data.content_prob * 100).toFixed(1) + '%' : 'N/A'}</span>
                                        ${data.content_prob ? `
                                        <div class="score-bar">
                                            <div class="score-fill" style="width: ${100 - data.content_prob * 100}%"></div>
                                        </div>` : ''}
                                    </div>
                                </div>
                                <div class="warning-box">
                                    ${data.warning || ''}
                                </div>
                                ${!data.suspicious ? `
                                <div class="actions">
                                    <button onclick="window.open('${text}', '_blank')" class="btn-primary">
                                        <i class="fas fa-external-link-alt"></i> Open URL
                                    </button>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    resultsDiv.innerHTML = `
                        <div class="result error">
                            <i class="fas fa-times-circle"></i>
                            <h3>Analysis Failed</h3>
                            <p>Error: ${error.message}</p>
                            <div class="content-box">
                                <p><strong>Raw QR Content:</strong></p>
                                <div class="text-display">${text.substring(0, 200)}${text.length > 200 ? '...' : ''}</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                resultsDiv.innerHTML = `
                    <div class="result info">
                        <div class="result-header">
                            <i class="fas fa-info-circle"></i>
                            <h3>QR Content (Not a URL)</h3>
                            <span class="scan-type">Text Detected</span>
                        </div>
                        <div class="content-box">
                            <p><strong>Scanned Content:</strong></p>
                            <div class="text-display">${text}</div>
                        </div>
                        <div class="details">
                            <p><i class="fas fa-info-circle"></i> This QR code contains plain text, not a website URL.</p>
                            <div class="actions">
                                <button onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')" class="btn-secondary">
                                    <i class="fas fa-copy"></i> Copy Text
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function checkManualInput() {
            const text = document.getElementById('manual-input').value.trim();
            if (text) {
                onScanSuccess(text);
            }
        }
        
        function renderScanHistory() {
            const historyDiv = document.getElementById('scan-history');
            if (scanHistory.length === 0) {
                historyDiv.innerHTML = '<p class="empty-history">No scan history yet</p>';
                return;
            }
            
            historyDiv.innerHTML = scanHistory.map((item, index) => `
                <div class="history-item ${item.isUrl ? 'url-item' : 'text-item'}" onclick="loadFromHistory('${item.text.replace(/'/g, "\\'")}')">
                    <div class="history-icon">
                        <i class="fas ${item.isUrl ? 'fa-link' : 'fa-font'}"></i>
                    </div>
                    <div class="history-content">
                        <div class="history-text">${item.text.substring(0, 50)}${item.text.length > 50 ? '...' : ''}</div>
                        <div class="history-time">${new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function loadFromHistory(text) {
            document.getElementById('manual-input').value = text;
            processScannedContent(text);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            });
        }
    </script>
</body>
</html>